name: Post to Bluesky on New Diary

on:
  push:
    branches:
      - main
    paths:
      - 'content/diary/*.md'

jobs:
  post-to-bluesky:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get New File Info
        id: file_info
        run: |
          # 新規追加(A)されたファイルのみを特定
          ADDED_FILE=$(git diff --name-only --diff-filter=A HEAD^ HEAD | grep '^content/diary/' | head -n 1)
          
          if [ -z "$ADDED_FILE" ]; then
            echo "No new diary file added."
            exit 0
          fi

          # 1. URL用のファイル名（拡張子なし）を取得
          FILENAME=$(basename "$ADDED_FILE" .md)
          DIARY_URL="https://my-simple-diary.pages.dev/diary/${FILENAME}/"
          
          # 2. ファイル内の "title: " 行から日記のタイトルを抽出
          # 例: title: 2026年2月7日（土） -> 2026年2月7日（土）
          # 前後の引用符やスペースを除去します
          TITLE=$(grep '^title:' "$ADDED_FILE" | sed -E 's/^title:[[:space:]]*["'\'']?//; s/["'\'']?[[:space:]]*$//')

          # もしタイトルが取れなかった場合のバックアップ
          if [ -z "$TITLE" ]; then TITLE="$FILENAME"; fi
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=$DIARY_URL" >> $GITHUB_OUTPUT

      - name: Send Bluesky Post
        if: steps.file_info.outputs.title != ''
        uses: myConsciousness/bluesky-post@v5
        with:
          text: |
            ${{ steps.file_info.outputs.title }}の日記が投稿されました
            ${{ steps.file_info.outputs.url }}
          identifier: ${{ secrets.BLUESKY_IDENTIFIER }}
          password: ${{ secrets.BLUESKY_PASSWORD }}
